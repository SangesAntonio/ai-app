<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizzazione Terremoti 3D</title>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

        document.addEventListener("DOMContentLoaded", () => {
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById("graficoContainer").appendChild(renderer.domElement);

            // Controlli orbitali
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Luce ambientale
            const light = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(light);

            // Griglia
            const gridHelper = new THREE.GridHelper(50, 50, 0xffffff, 0xffffff);
            scene.add(gridHelper);

            function latLonToXYZ(lat, lon, depth) {
                const scale = 10;
                return { x: (lon - 10) * scale, y: (lat - 40) * scale, z: -depth * 2 };
            }

            function getMagnitudo(earthquake) {
                return earthquake.magnitudos?.[0]?.value || 1;
            }

            function isValidCoordinate(lat, lon, depth) {
                return !isNaN(lat) && !isNaN(lon) && !isNaN(depth) && lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
            }

            fetch('events25.json')
                .then(response => response.json())
                .then(data => {
                    if (!Array.isArray(data)) {
                        console.error("Errore: Il JSON non Ã¨ un array.");
                        return;
                    }

                    data.forEach(eq => {
                        const { latitude, longitude, depth } = eq.location;
                        if (!isValidCoordinate(latitude, longitude, depth)) return;

                        const { x, y, z } = latLonToXYZ(latitude, longitude, depth);
                        if (isNaN(x) || isNaN(y) || isNaN(z)) return;

                        const magnitudo = getMagnitudo(eq);
                        if (magnitudo <= 0) return;

                        let luminosita = Math.max(0, Math.min(100, 100 - depth * 5));
                        const color = new THREE.Color(`hsl(0, 100%, ${luminosita}%)`);

                        const geometry = new THREE.SphereGeometry(magnitudo * 0.5);
                        const material = new THREE.MeshBasicMaterial({ color });
                        const sphere = new THREE.Mesh(geometry, material);
                        sphere.position.set(x, y, z);

                        scene.add(sphere);
                    });
                })
                .catch(error => console.error("Errore nel caricamento del JSON:", error));

            camera.position.set(0, 30, 50);

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        });
    </script>
    <style>
        body { margin: 0; overflow: hidden; background-color: white; }
        #graficoContainer { width: 100vw; height: 100vh; }
    </style>
</head>
<body>
    <div id="graficoContainer"></div>
</body>
</html>
